#!/bin/bash
BUILD_DIR=`pwd`
COPYRIGHT="# Copyright `date +%Y` Bifrost Entertainment. All rights reserved."
HEADER="# This file was generated by $0"
NDK_HOME="$HOME/bin/android-ndk"
PROJECT="$(cd -P "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
TARGET=rainbow

echo -n "Generating jni/Android.mk..."

# Gather Rainbow source files
cd $PROJECT
SRC_FILES=`find src -name 'Platform' -prune -o -name '*.cpp' | xargs`

# Include libraries
for lib in Box2D Lua libpng; do
	SRC_FILES="$SRC_FILES \\"$'\n'`find lib/$lib -name '*.c' -and ! -name 'lua.c' -and ! -name 'luac.c' -and ! -name 'pngwutil.c' -or -name '*.cpp' | xargs`
done

# Manually include FreeType source
SRC_FILES="$SRC_FILES lib/FreeType/src/autofit/autofit.c lib/FreeType/src/base/ftbase.c lib/FreeType/src/base/ftbbox.c lib/FreeType/src/base/ftbitmap.c lib/FreeType/src/base/ftdebug.c lib/FreeType/src/base/ftglyph.c lib/FreeType/src/base/ftinit.c lib/FreeType/src/base/ftsystem.c lib/FreeType/src/cff/cff.c lib/FreeType/src/pshinter/pshinter.c lib/FreeType/src/psnames/psnames.c lib/FreeType/src/sfnt/sfnt.c lib/FreeType/src/smooth/smooth.c lib/FreeType/src/truetype/truetype.c"

cd $BUILD_DIR
mkdir -p jni
echo "\
$COPYRIGHT
$HEADER

#LOCAL_PATH := \$(call my-dir)
LOCAL_PATH := $PROJECT

include \$(CLEAR_VARS)

LOCAL_MODULE := $TARGET
LOCAL_SRC_FILES := $SRC_FILES

LOCAL_C_INCLUDES := $PROJECT/src $PROJECT/lib $PROJECT/lib/FreeType/include $PROJECT/lib/libpng $PROJECT/lib/Lua $NDK_HOME/sources/android/native_app_glue
LOCAL_CFLAGS := -DDARWIN_NO_CARBON -DFT2_BUILD_LIBRARY -finline-functions -ftree-vectorize

LOCAL_LDLIBS := -landroid -lEGL -lGLESv2 -lOpenSLES -ldl -llog -lz
LOCAL_STATIC_LIBRARIES := android_native_app_glue

include \$(BUILD_SHARED_LIBRARY)
\$(call import-module,android/native_app_glue)" \
> jni/Android.mk
echo " done"

echo -n "Generating jni/Application.mk..."
echo "\
$COPYRIGHT
$HEADER

APP_PLATFORM := android-14
APP_ABI := x86  # armeabi-v7a  # all
APP_STL := stlport_static  # Required by Box2D" \
> jni/Application.mk
echo " done"

echo -n "Generating AndroidManifest.xml..."
echo "\
<?xml version=\"1.0\" encoding=\"utf-8\"?>
<manifest xmlns:android=\"http://schemas.android.com/apk/res/android\"
          package=\"com.bifrostentertainment.rainbow\"
          android:versionCode=\"1\"
          android:versionName=\"1.0\">
	<application android:icon=\"@drawable/icon\" android:label=\"@string/app_name\" android:debuggable=\"true\">
		<activity android:name=\"android.app.NativeActivity\" android:label=\"@string/app_name\">
			<meta-data android:name=\"android.app.lib_name\" android:value=\"rainbow\" />
			<intent-filter>
				<action android:name=\"android.intent.action.MAIN\" />
				<category android:name=\"android.intent.category.LAUNCHER\" />
			</intent-filter>
		</activity>
	</application>
	<uses-feature android:glEsVersion=\"0x00020000\" />
	<uses-sdk android:minSdkVersion=\"14\" />
</manifest>" \
> AndroidManifest.xml
echo " done"

$NDK_HOME/ndk-build $@
